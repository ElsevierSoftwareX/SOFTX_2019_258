
PREFIX schema:    <http://schema.org/>
PREFIX rdfs:      <http://www.w3.org/2000/01/rdf-schema#>
PREFIX pc:        <http://purl.org/procurement/public-contracts#>
PREFIX gr:        <http://purl.org/goodrelations/v1#>
PREFIX owl:       <http://www.w3.org/2002/07/owl#>
PREFIX adms:      <http://www.w3.org/ns/adms#>
PREFIX c4n:       <http://vocab.deri.ie/c4n#>
PREFIX dcterms:   <http://purl.org/dc/terms/>
PREFIX foaf:      <http://xmlns.com/foaf/0.1/>
PREFIX loted:     <http://www.loted.eu/ontology#>
PREFIX payment:   <http://reference.data.gov.uk/def/payment#>
PREFIX qb:        <http://purl.org/linked-data/cube#>
PREFIX rdf:       <http://www.w3.org/1999/02/22-rdf-syntax-ns#>
PREFIX skos:      <http://www.w3.org/2004/02/skos/core#>
PREFIX vann:      <http://purl.org/vocab/vann/>
PREFIX xsd:       <http://www.w3.org/2001/XMLSchema#>
PREFIX owl:       <http://www.w3.org/2002/07/owl#>
PREFIX jarql:    <http://jarql.com/>

CONSTRUCT {
    ?Contract dcterms:identifier ?cig.
    ?Contract rdfs:description ?oggetto.
    ?Contract pc:contractingAuthority ?BusinessEntity.

    ?BusinessEntity dcterms:identifier ?strutturaProponenteCodiceFiscaleProp.
    ?BusinessEntity rdfs:label ?strutturaProponenteLabel.

    ?Contract pc:tender ?tenderURI.
    ?tenderURI a pc:Tender .
    ?tenderURI pc:bidder ?partecipante.

    ?partecipante  dcterms:identifier ?partecipanticodiceFiscale.
    ?partecipante rdfs:label ?partecipantiragioneSociale.
    ?partecipante a gr:BusinessEntity.

    ?Contract pc:awardedTender ?awardedTenderURI.
    ?tenderURI a pc:Tender .
    ?tenderURI pc:bidder ?vincitore.

    ?vincitore  dcterms:identifier ?vincitoricodiceFiscale.
    ?vincitore rdfs:label ?vincitoriragioneSociale.
}

WHERE {
    jarql:root jarql:cig ?cig.
    OPTIONAL { jarql:root jarql:oggetto ?oggetto. }
    OPTIONAL { jarql:root jarql:strutturaProponente ?strutturaProponente.
      OPTIONAL { ?strutturaProponente jarql:codiceFiscaleProp ?strutturaProponenteCodiceFiscaleProp. }
      OPTIONAL { ?strutturaProponente jarql:denominazione ?strutturaProponenteLabel. }
    }

    OPTIONAL {
      jarql:root jarql:partecipanti ?partecipanti.
      OPTIONAL { ?partecipanti jarql:codiceFiscale ?partecipanticodiceFiscale. }
      OPTIONAL { ?partecipanti jarql:ragioneSociale ?partecipantiragioneSociale . }
    }

    OPTIONAL {
      jarql:root jarql:aggiudicatari ?vincitori.
      OPTIONAL { ?vincitori jarql:codiceFiscale ?vincitoricodiceFiscale. }
      OPTIONAL { ?vincitori jarql:ragioneSociale ?vincitoriragioneSociale . }
    }


    BIND (URI(CONCAT('http://purl.org/procurement/public-contracts/contract/',?cig)) as ?Contract)
    BIND (URI(CONCAT('http://purl.org/goodrelations/v1/businessentity/',?strutturaProponenteCodiceFiscaleProp)) as?BusinessEntity)
    BIND (URI(CONCAT('http://purl.org/goodrelations/v1/businessentity/',?partecipanticodiceFiscale)) as ?partecipante)
    BIND (URI(CONCAT('http://purl.org/goodrelations/v1/businessentity/',?vincitoricodiceFiscale)) as ?vincitore)
    BIND (URI(CONCAT('http://pc.org/tenders/', ?cig, '-', ?partecipanticodiceFiscale)) as ?tenderURI)
    BIND (URI(CONCAT('http://pc.org/awardedTenders/', ?cig, '-', ?vincitoricodiceFiscale)) as ?awardedTenderURI)
}
